var ylkMonitor=function(){"use strict";function o(n,t){this.config=n,this.submit_log=[],this.baseInfo=null,this.error_times={},this.merge_lock=!1,this.events={},this.push=function(e){this.isRepeat(e)||(this.submit_log.push(e),this.report())},this.report=function(){var e=this;if(n.mergeReport&&0<this.submit_log.length){if(this.merge_lock)return;e.merge_lock=!0,setTimeout(function(){e.submit(),e.merge_lock=!1},1e3*n.delay)}else e.submit()},this.submit=function(e){var r={id:n.id,log:e?[e]:this.submit_log,baseInfo:null,userInfo:null,time:(new Date).getTime()};r.baseInfo=this.baseInfo?this.baseInfo:this.getBaseInfo(),this.config.userInfo instanceof Function?r.userInfo=this.config.userInfo():"string"==typeof this.config.userInfo&&(r.userInfo=this.config.userInfo);var t=new XMLHttpRequest;t.open("post",n.url),t.setRequestHeader("Content-type","application/json"),this.trigger("beforeReport",r),t.send(JSON.stringify(r)),e||(this.submit_log=[]),t.onreadystatechange=function(){4==t.readyState&&200==t.status&&this.trigger("afterReport",r)}},this.getBaseInfo=function(){var e=t||window,r={userAgent:e.navigator.userAgent,deviceWidth:e.screen.width,deviceHeight:e.screen.height,url:e.location.href};return this.baseInfo=r},this.isRepeat=function(e){if(e.hash){var r=this.error_times[e.hash]=(this.error_times[e.hash]||0)+1;return 0<n.error.repeat&&r>n.error.repeat}return!1},this.trigger=function(e,r){this.events[e]&&0<this.events[e].length&&this.events[e].forEach(function(e){e(r)})},this.on=function(e,r){this.events[e]?this.events[e].push(r):this.events[e]=[r]}}var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_-".split(""),s=function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t]);return e},a=function(e){var r=window.onload;"function"!=typeof window.onload?window.onload=e:window.onload=function(){r(),e()}},f=function(e,r){return Object.prototype.toString.call(e)==="[object "+(r||"Object")+"]"},u=function(e){var r=e.stack.replace(/\n/gi,"").split(/\bat\b/).slice(0,9).join("@").replace(/\?[^:]+/gi,""),t=e.toString();return r.indexOf(t)<0&&(r=t+"@"+r),r},c=function(e){var r=5381,t=e.length-1;if("string"==typeof e)for(;-1<t;t--)r+=(r<<5)+e.charCodeAt(t);else for(;-1<t;t--)r+=(r<<5)+e[t];for(var n=2147483647&r,o="";o+=i[63&n],n>>=6;);return o};var h={id:"",version:"",mergeReport:!0,delay:1,url:"http://127.0.0.1:5500",random:1,performance:{open:!0,random:1},error:{open:!0,random:1,repeat:5,ignore:[]},waitLoadTime:5,userInfo:""};return window.ylkMonitor={init:function(e){var r=window;if(e.url)if(e.id){!0===e.performance||void 0===e.performance?e.performance=h.performance:e.performance&&(e.performance=s(h.performance,e.performance)),!0===e.error||void 0===e.error?e.error=h.error:e.error&&(e.error=s(h.error,e.error));var t=s(h,e),n=this.reporter=new o(t,r,this.onSubmit);t.performance&&!0===t.performance.open&&function(o,e,i){if(!(Math.random()>(e.performance.random||e.random))){var r=!1,s=!1;a(function(){s||(t(),r=!0)}),setTimeout(function(){r||t()},1e3*e.waitLoadTime)}function t(){var e=o.performance||window.performance;if(e&&e.timing){var r=e.timing,t={};for(var n in r)"number"==typeof r[n]&&(t[n]=(r[n]+"").substring(6));return i.submit({type:"performance",data:t}),s=!0,t}}}(r,t,n),t.error&&!0===t.error.open&&function(e,s,r){function a(e){r.push({type:"error",data:e,hash:c(JSON.stringify(e))})}(e||window).onerror=function(e,r,t,n,o){var i=e;o&&o.stack&&(i=u(o)),f(i,"Event")&&(i+=i.type?"--"+i.type+"--"+(i.target?i.target.tagName+"::"+i.target.src:""):""),Math.random()<(s.error.random||s.random)&&a({msg:i,target:r,rowNum:t,colNum:n,_orgMsg:e})},window.addEventListener("error",function(e){e.stopImmediatePropagation();var r=e.srcElement;r===window||Math.random()<(s.error.random||s.random)&&a({url:r.src||r.href,tag:r.tagName})},!0),window.addEventListener("unhandledrejection",function(e){e.preventDefault(),Math.random()<(s.error.random||s.random)&&a({msg:e.reason.message||"_",stack:e.reason.stack||"_"})})}(r,t,n),this.IS_INIT=!0}else console.warn("ylkMonitor options’s id is needed");else console.warn("ylkMonitor options’s url is needed")},push:function(e){this.IS_INIT&&this.reporter&&this.reporter.push(e)},submit:function(e){this.IS_INIT&&this.reporter&&this.reporter.submit(e)},on:function(e,r){this.IS_INIT&&this.reporter&&this.reporter.on(e,r)}}}();
